<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UAV Payload Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#121212; --fg:#e5e7eb; --panel:#1b1b1b; --border:#2e2e2e;
  --accent:#4ea8de; --ok:#16a34a; --bad:#dc2626; --card:#111; --shadow:0 10px 30px rgba(0,0,0,.25);
}
body.light{
  --bg:#ffffff; --fg:#111827; --panel:#f8fafc; --border:#e5e7eb;
  --accent:#2563eb; --card:#fff; --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box;}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg);}
header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:center;}
header h1{margin:0;font-size:18px;font-weight:600;}
.mode-toggle-wrapper{position:absolute;top:10px;right:16px;display:flex;align-items:center;gap:6px;}
.switch{position: relative; display: inline-block; width:40px; height:20px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:.4s; border-radius:20px;}
.slider:before{position:absolute; content:""; height:16px; width:16px; left:2px; bottom:2px; background:white; transition:.4s; border-radius:50%;}
input:checked + .slider{ background:var(--accent);}
input:checked + .slider:before{ transform:translateX(20px);}
.tabs{display:flex;gap:8px;justify-content:center;background:var(--panel);border-bottom:1px solid var(--border);padding:8px;}
.tab-btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 14px;border-radius:10px;cursor:pointer;transition:.2s;}
.tab-btn:hover{transform: translateY(-1px);}
.tab-btn.active{outline:2px solid var(--accent);}
.tab{display:none;padding:12px;}
.tab.active{display:block;}
.dashboard{display:grid; grid-template-columns:160px 1fr 360px; gap:12px; min-height:calc(100vh - 150px);}
.thumbs{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;overflow:auto;box-shadow: var(--shadow);}
.thumbs img{width:100%; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border); cursor:pointer;}
.thumbs img:hover{border-color:var(--accent);}
.main-image{background:var(--panel);border:1px solid var(--border);border-radius:12px; display:flex;align-items:center;justify-content:center;padding:8px;box-shadow: var(--shadow);}
.main-image img{width:100%;height:100%;max-height:70vh;object-fit:contain;border-radius:8px;}
.right-col{display:flex;flex-direction:column;gap:12px;}
.mini-card,.status-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow: var(--shadow);}
.mini-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;}
.mini-tabs button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);cursor:pointer;}
.mini-tabs button.active{outline:2px solid var(--accent);}
.mini-wrap{height:220px;}
.mini-wrap canvas{width:100%;height:100%;}
.kv{display:grid; grid-template-columns: 140px 1fr; gap:4px; font-size:14px;}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--card); border:1px solid var(--border);}
.on{background: var(--ok); color:#fff;}
.off{background: var(--bad); color:#fff;}
.chart-grid{display:grid; grid-template-columns: repeat(3,1fr); grid-auto-rows:260px; gap:12px;}
.chart-box{position:relative; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; box-shadow: var(--shadow);}
.chart-box canvas{width:100%; height:100%; object-fit:contain;}
.chart-actions{position:absolute; top:6px; right:6px; display:flex; gap:4px;}
.icon-btn{border:1px solid var(--border); background:var(--card); color:var(--fg); border-radius:6px; padding:2px 4px; font-size:12px; cursor:pointer;}
.logs-wrap{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow: var(--shadow);}
table{width:100%; border-collapse: collapse; font-size:14px;}
th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;}
thead th{position:sticky; top:0; background:var(--panel);}
.logs-actions{display:flex;gap:8px;margin-bottom:8px;}
@media(max-width:980px){
  .dashboard{grid-template-columns:1fr;}
  .thumbs{flex-direction:row;}
  .thumbs img{width:160px; height:96px;}
  .main-image img{max-height:40vh;}
  .chart-grid{grid-template-columns: repeat(2,1fr); grid-auto-rows:260px;}
}
</style>
</head>
<body>
<header>
<h1>UAV Payload Dashboard</h1>
<div class="mode-toggle-wrapper">
  <span>Light</span>
  <label class="switch">
    <input type="checkbox" id="modeSlider">
    <span class="slider round"></span>
  </label>
  <span>Dark</span>
</div>
</header>

<nav class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="dash">Dashboard</button>
  <button class="tab-btn" data-tab="charts">Charts</button>
  <button class="tab-btn" data-tab="logs">Logs</button>
</nav>

<section id="dash" class="tab active">
<div class="dashboard">
  <aside class="thumbs">
    <img src="/static/last_pressure.jpg" onclick="showImage(this.src)">
    <img src="/static/last_marker.jpg" onclick="showImage(this.src)">
    <img src="/static/valve.jpg" onclick="showImage(this.src)">
    <img id="cameraThumb" src="/camera_feed" onclick="showImage(this.src)">
  </aside>
  <main class="main-image">
    <img id="mainImage" src="/camera_feed" />
  </main>
  <div class="right-col">
    <section class="mini-card">
      <div class="mini-tabs">
        <button class="mini-btn active" data-mini="temp">Temp</button>
        <button class="mini-btn" data-mini="hum">Humidity</button>
        <button class="mini-btn" data-mini="light">Light</button>
        <button class="mini-btn" data-mini="press">Pressure</button>
        <button class="mini-btn" data-mini="red_gas">Reducing Gas</button>
        <button class="mini-btn" data-mini="ox_gas">Oxidising Gas</button>
        <button class="mini-btn" data-mini="nh3">NH3</button>
      </div>
      <div class="mini-wrap"><canvas id="miniCanvas"></canvas></div>
    </section>
    <section class="status-card">
      <div class="kv"><div>Target Found:</div><div><span id="badge-found" class="badge off">No</span></div></div>
      <div class="kv"><div>Type:</div><div id="target-type">--</div></div>
      <div class="kv"><div>Temp (°C):</div><div id="val-temp">--</div></div>
      <div class="kv"><div>Humidity (%):</div><div id="val-hum">--</div></div>
      <div class="kv"><div>Light (lux):</div><div id="val-light">--</div></div>
      <div class="kv"><div>Pressure (hPa):</div><div id="val-press">--</div></div>
      <div class="kv"><div>Reducing Gas (ppm):</div><div id="val-red_gas">--</div></div>
      <div class="kv"><div>Oxidising Gas (ppm):</div><div id="val-ox_gas">--</div></div>
      <div class="kv"><div>NH3 (ppm):</div><div id="val-nh3">--</div></div>
    </section>
  </div>
</div>
</section>

<section id="charts" class="tab">
<div class="chart-grid">
  <div class="chart-box" data-chart="temp"><canvas id="chart-temp"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="hum"><canvas id="chart-hum"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="light"><canvas id="chart-light"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="press"><canvas id="chart-press"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="red_gas"><canvas id="chart-red_gas"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="ox_gas"><canvas id="chart-ox_gas"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
  <div class="chart-box" data-chart="nh3"><canvas id="chart-nh3"></canvas><div class="chart-actions"><button class="icon-btn" onclick="toggleFullscreen(this)">⤢</button></div></div>
</div>
</section>

<section id="logs" class="tab">
<div class="logs-wrap">
<div class="logs-actions">
<button class="icon-btn" onclick="exportCSV()">Export CSV</button>
<button class="icon-btn" onclick="clearLogs()">Clear</button>
</div>
<div style="overflow:auto; max-height:70vh">
<table>
<thead><tr><th>Time</th><th>Temp</th><th>Hum</th><th>Light</th><th>Press</th><th>Red Gas</th><th>Ox Gas</th><th>NH3</th></tr></thead>
<tbody id="logs-body"></tbody>
</table>
</div>
</div>
</section>

<script>
// ------------------- TABS -------------------
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    resizeAllCharts();
  });
});

// ------------------- IMAGE -------------------
function showImage(src){ document.getElementById('mainImage').src=src; }

// ------------------- CHART SETUP -------------------
const sensors=['temp','hum','light','press','red_gas','ox_gas','nh3'];
const sensorUnits={temp:'°C',hum:'%',light:'lux',press:'hPa',red_gas:'ppm',ox_gas:'ppm',nh3:'ppm'};
const sensorColors={temp:'#f87171',hum:'#60a5fa',light:'#facc15',press:'#34d399',red_gas:'#f472b6',ox_gas:'#a78bfa',nh3:'#fbbf24'};

const MAX_POINTS=120;
const stream={};
sensors.forEach(s=>stream[s]={labels:[],data:[]});
const logs=[];

function pushPoint(key,t,v){
  const buf=stream[key];
  buf.labels.push(t);
  buf.data.push(v);
  if(buf.labels.length>MAX_POINTS){ buf.labels.shift(); buf.data.shift(); }
}

function makeChart(canvasId,sensor){
  const ctx=document.getElementById(canvasId).getContext('2d');
  const ch=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:sensor,data:[],borderWidth:2,fill:false,tension:0.3,pointRadius:0,borderColor:sensorColors[sensor]}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{legend:{labels:{color:getComputedStyle(document.body).getPropertyValue('--fg')}}},
      scales:{
        x:{display:true,title:{display:true,text:'Time',color:getComputedStyle(document.body).getPropertyValue('--fg')},ticks:{color:getComputedStyle(document.body).getPropertyValue('--fg')}},
        y:{display:true,title:{display:true,text:sensor+' ('+sensorUnits[sensor]+')',color:getComputedStyle(document.body).getPropertyValue('--fg')},ticks:{color:getComputedStyle(document.body).getPropertyValue('--fg')}}
      }
    }
  });
  ctx.chart=ch;
  return ch;
}

const charts={};
sensors.forEach(s=>charts[s]=makeChart('chart-'+s,s));

let miniSensor='temp';
const miniChart=makeChart('miniCanvas',miniSensor);

document.querySelectorAll('.mini-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.mini-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    miniSensor=b.dataset.mini;
    syncMiniToBuffer();
  });
});

function syncChartToBuffer(sensor){
  const ch=charts[sensor];
  const buf=stream[sensor];
  ch.data.labels=buf.labels.slice();
  ch.data.datasets[0].data=buf.data.slice();
  ch.update('none');
}

function syncMiniToBuffer(){
  const buf=stream[miniSensor];
  miniChart.data.labels=buf.labels.slice();
  miniChart.data.datasets[0].data=buf.data.slice();
  miniChart.data.datasets[0].label=miniSensor;
  miniChart.data.datasets[0].borderColor=sensorColors[miniSensor];
  miniChart.options.scales.y.title.text=miniSensor+' ('+sensorUnits[miniSensor]+')';
  miniChart.update('none');
}

function resizeAllCharts(){ Object.values(charts).forEach(c=>c.resize()); miniChart.resize(); }
new ResizeObserver(resizeAllCharts).observe(document.body);

// ------------------- DARK/LIGHT MODE -------------------
const modeSlider=document.getElementById('modeSlider');

function applyMode(isLight){
  document.body.classList.toggle('light', isLight);
  resizeAllCharts();
}

function detectSystemMode(){
  const isLight=!window.matchMedia('(prefers-color-scheme: dark)').matches;
  modeSlider.checked=isLight;
  applyMode(isLight);
}
modeSlider.addEventListener('change',()=>applyMode(modeSlider.checked));
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',detectSystemMode);
detectSystemMode();

// ------------------- FULLSCREEN -------------------
function toggleFullscreen(btn){
  const box=btn.closest('.chart-box');
  if(!document.fullscreenElement){ box.requestFullscreen().then(()=>{ box.classList.add('fullscreen'); resizeAllCharts(); }).catch(console.error);}
  else{ document.exitFullscreen().then(()=>{ box.classList.remove('fullscreen'); resizeAllCharts(); }).catch(console.error);}
}

// ------------------- LIVE DATA UPDATE -------------------
async function updateData(){
  try{
    const resp = await fetch("/data");
    const data = await resp.json();
    const t = new Date().toLocaleTimeString();

    sensors.forEach(s=>{
      const val = parseFloat(data[s]) || 0;
      document.getElementById('val-'+s).textContent = val.toFixed(2);
      pushPoint(s,t,val);
      syncChartToBuffer(s);
    });

    // Update mini chart
    syncMiniToBuffer();

    // Update badge
    const badge=document.getElementById('badge-found');
    badge.className='badge '+(data.target_found?'on':'off');
    badge.textContent = data.target_found?'Yes':'No';
    document.getElementById('target-type').textContent = data.target_type;

    // Update camera feed
    const cam = document.getElementById('mainImage');
    const thumb = document.getElementById('cameraThumb');
    cam.src = "/camera_feed?"+new Date().getTime();
    thumb.src = "/camera_feed?"+new Date().getTime();

    // Logs
    const logEntry={time:t};
    sensors.forEach(s=>logEntry[s]=parseFloat(data[s])||0);
    logs.push(logEntry);
    renderLogs();
  }catch(err){
    console.error(err);
  }
}

function renderLogs(){
  const tbody=document.getElementById('logs-body');
  tbody.innerHTML='';
  logs.slice(-50).forEach(l=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${l.time}</td>`+sensors.map(s=>`<td>${l[s].toFixed(2)}</td>`).join('');
    tbody.appendChild(tr);
  });
}

function exportCSV(){
  let csv='Time,'+sensors.join(',')+'\n';
  logs.forEach(l=>{
    csv+=l.time+','+sensors.map(s=>l[s].toFixed(2)).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='logs.csv'; a.click();
  URL.revokeObjectURL(url);
}

function clearLogs(){ logs.length=0; renderLogs(); }

// ------------------- AUTO REFRESH -------------------
setInterval(updateData, 500); // refresh every 0.5s

</script>
</body>
</html>
